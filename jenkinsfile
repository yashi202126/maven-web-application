def TAG = "$BUILD_NUMBER"

pipeline {
    agent any
    
 tools {
  maven "MAVEN"
  
}
    stages {
        stage('git-Clone') {
            steps {
         git credentialsId: 'github', url: 'https://github.com/kuber416/maven-web-application.git'
            } 
         }
        stage('Build the package') {
            steps {
                sh "mvn clean package"
            }
         }
        stage('Build Docker Image') {
            steps {
               sh "docker build -t kuber416/maven-web-application:${TAG} ."
            } 
         } 

        stage('Push Docker image to Docker Hub registry') {
            steps {
            withCredentials([string(credentialsId: 'DOCKER_HUB_PASSWORD', variable: 'DOCKER_HUB_PASSWORD')]) {
                 sh "docker login -u kuber416 -p ${DOCKER_HUB_PASSWORD}"
                 sh "docker push kuber416/maven-web-application:${TAG}"
           }
        }

       stage(' push Docker image to Docker Hub registry')
       
        stage('update Yaml file') {
            steps {
                sh "sed -i 's/TAG/$TAG/' mavenwebappdeployment.yaml"
           }
       } 
       stage('depoly container In k8s via Jenkins') {
           steps {
               sh "kubectl apply -f mavenwebappdeployment.yaml"
          }
        }
     }
   }
}
