def TAG = "$BUILD_NUMBER"

pipeline {
    agent any
    
 tools {
  maven "MAVEN"
  
}
    stages {
        stage('git-Clone') {
            steps {
         git credentialsId: 'github', url: 'https://github.com/kuber416/maven-web-application.git'
            } 
         }
        stage('Build the package') {
            steps {
                sh "mvn clean package"
            }
         }
        stage('Build Docker Image') {
            steps {
               sh "docker build -t kuber416/maven-web-application:${TAG} ."
            } 
         } 
       stage('Push Docker image to Docker Hub registry') {
           steps {
            withCredentials([string(credentialsId: 'DOCKER_HUB_PASSWORD', variable: 'DOCKER_HUB_PASSWORD')]) {
                 sh "docker login -u kuber416 -p ${DOCKER_HUB_PASSWORD}"
                 sh "docker push kuber416/maven-web-application:${TAG}"
                 }
              }
            }
      stage('update Yaml file') {
            steps {
                sh "sed -i 's/TAG/$TAG/' mavenwebappdeployment.yaml"
           }
       } 
       stage('depoly container In k8s via Jenkins') {
           steps {
                  kubeconfig(credentialsId: 'kubernetes-cred', serverUrl: ' https://4BD913A239DDDE25758D2E0309B41D3E.gr7.ap-south-1.eks.amazonaws.com', caCertificate: credentials('kubernetes-ca-cert')) {
                  sh "kubectl apply -f mavenwebappdeployment.yaml"
                  }
                }
              }
           }
         }
